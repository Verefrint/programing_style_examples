version: '3.8'

services:
  mattermost:
    image: mattermost/mattermost-team-edition:release-11.2
    environment:
      # Database configuration using the correct variable names
      - MM_SQLSETTINGS_DRIVERNAME=postgres
      - MM_SQLSETTINGS_DATASOURCE=postgres://mmuser:mmuser_password@db:5432/mattermost_test?sslmode=disable&connect_timeout=10
      
      # Site URL (optional but recommended)
      - MM_SERVICESETTINGS_SITEURL=http://localhost:8065
      
      # Bleve settings for search indexing
      - MM_BLEVESETTINGS_INDEXDIR=/mattermost/bleve-indexes
      
      # Timezone
      - TZ=UTC
    ports:
      - "8065:8065"
    depends_on:
      - db
    networks:
      - mattermost_network
    volumes:
      # Mount more volumes like in the official example
      - mattermost_data:/mattermost/data
      - mattermost_config:/mattermost/config:rw
      - mattermost_logs:/mattermost/logs:rw
      - mattermost_plugins:/mattermost/plugins:rw
      - mattermost_client_plugins:/mattermost/client/plugins:rw
      - mattermost_bleve_indexes:/mattermost/bleve-indexes:rw

  db:
    image: postgres:15.15
    environment:
      - POSTGRES_USER=mmuser
      - POSTGRES_PASSWORD=mmuser_password
      - POSTGRES_DB=mattermost_test
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - mattermost_network

networks:
  mattermost_network:
    driver: bridge

volumes:
  mattermost_data:
  mattermost_config:
  mattermost_logs:
  mattermost_plugins:
  mattermost_client_plugins:
  mattermost_bleve_indexes:
  postgres_data: